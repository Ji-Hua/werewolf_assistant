{% extends "base.html" %}

{% block content %}
    <h1>æ¸¸æˆ {{ room.name }}</h1>
    <h4>å½“å‰æ¸¸æˆè®¾ç½®ä¸º {{ room.game.template }}</h4>
    {% if current_user.is_host(room.name) %}
        <h3>ä½ ä¸ºæœ¬æ¸¸æˆçš„ä¸Šå¸</h3>
        <div id='pregame-action-div'>
            <input id="assign-characters-button" name="submit" type="submit" value="åˆ†å‘èº«ä»½">
            <input id="start-game-button" name="submit" type="submit" value="å¼€å§‹æ¸¸æˆ"><br>
        <div>
        <br>
        <div id='ingame-action-div' hidden>
            <div id='round-info-div'>
                <label for="round">é€‰æ‹©å½“å‰è½®æ¬¡</label><br>
                <select id="round-select" name="round">
                    <option value="è­¦é•¿ç«é€‰">è­¦é•¿ç«é€‰</option>
                    <option value="ç¬¬1å¤©">ç¬¬1å¤©</option>
                    <option value="ç¬¬2å¤©">ç¬¬2å¤©</option>
                    <option value="ç¬¬3å¤©">ç¬¬3å¤©</option>
                    <option value="ç¬¬4å¤©">ç¬¬4å¤©</option>
                    <option value="ç¬¬5å¤©">ç¬¬5å¤©</option>
                </select>
                <input id="round-button" name="submit" type="submit" value="ç¡®è®¤é˜¶æ®µ"><br>
            </div>
            <br>
            <select id='sheriff-select'></select>
            <input id="sheriff-button" name="submit" type="submit" value="æˆäºˆè­¦å¾½">
            <br>
            <div id='vote-buttons-div'>
                <input id="start-vote-button" name="submit" type="submit" value="å¼€å§‹æŠ•ç¥¨">
                <input id="end-vote-button" name="submit" type="submit" value="ç»“æŸæŠ•ç¥¨">
                <input id="view-vote-button" name="submit" type="submit" value="æŸ¥çœ‹æŠ•ç¥¨">
            </div>
            <br>
        </div>
        <script type="module">
            import { updateRound, assignCharacters } from '{{ url_for('static', filename='js/host.js') }}';
            var api_base = "/room/" + {{ room.name }} + "/" + {{ current_user.id }};

            $("#assign-characters-button").click(function() {
                updateRound(api_base, "åˆ†å‘èº«ä»½");
                assignCharacters(api_base);
            })
        </script>
    {% endif %}
    <h3>æ¸¸æˆçŠ¶æ€<h3>
    <br>
        <h4 id='round-info-head'></h4>
    <br>
    <div id='player-status'>
        <table id='player-status-table'>
        <thead>
            <tr>
                <th>åº§ä½å·</th>
                <th>ç©å®¶å</th>
                <th>è§’è‰²å</th>
                <th>å­˜æ´»çŠ¶æ€</th>
                <th>è­¦å¾½çŠ¶æ€</th>
                <th>æŠ•ç¥¨ç»™</th>
                <th>è¡ŒåŠ¨</th>
            <tr>
        </thead>
        <tbody>
            {% for i in range(1, 13) %}
            <tr class='player-status-table-row' id='player-status-table-row-{{i}}'>
                <td id='player-status-table-seat-{{i}}'>{{i}}</td>
                <td id='player-status-table-name-{{i}}'></td>
                <td id='player-status-table-character-{{i}}'></td>
                <td id='player-status-table-death-{{i}}'></td>
                <td id='player-status-table-sheriff-{{i}}'></td>
                <td id='player-status-table-votefor-{{i}}'></td>
                <td id='player-status-table-action-{{i}}'></td>
            </tr>
        {% endfor %}
        </tbody>
        </table>
    </div>
    {% if current_user.is_host(room.name) %}
        <script>
            var sheriff_api_url = "/room/" + {{ room.name }} + "/sheriff";
            $("#sheriff-button").click(function(){
                var data = {
                    seat: $( "#sheriff-select option:selected" ).val(),
                };
                console.log(data)
                $.ajax({
                    type: "POST",
                    url: sheriff_api_url,
                    data: data,
                    success: function(response) {
                        if (response.sheriff) {
                            console.log(response.sheriff)
                        }
                    }
                })
            })

            $("#round-button").click(function(){
                current_stage = $( "#round-select option:selected" ).val();
            })




            var current_stage = "è­¦é•¿ç«é€‰";
            var round_api_url = "/room/" + {{ room.name }} + "/round";
            $("#start-vote-button").click(function(){
                current_stage = $( "#round-select option:selected" ).val()
                var data = {
                    round_name: current_stage,
                    allow_vote: true,
                };
                $.ajax({
                    type: "POST",
                    url: round_api_url,
                    data: data,
                    success: function(response) {
                        if (response.vote == 1) {
                            $("#vote-stage").text('æŠ•ç¥¨å·²å¼€å¯')
                        } else {
                            $("#vote-stage").text('æŠ•ç¥¨å·²ç»“æŸ')
                        }
                    }
                })
            })

            $("#end-vote-button").click(function(){
                var data = {
                    round_name: $( "#round-select option:selected" ).val(),
                    allow_vote: false,
                };
                $.ajax({
                    type: "POST",
                    url: round_api_url,
                    data: data,
                    success: function(response) {
                        if (response.vote == 1) {
                            $("#vote-stage").text('æŠ•ç¥¨å·²å¼€å¯')
                        } else {
                            $("#vote-stage").text('æŠ•ç¥¨å·²ç»“æŸ')
                        }
                    }
                });
                viewResults();
            })

            var seat_api_url = "/room/" + {{ room.name }} + "/" + {{ current_user.id }} + "/seats";
            function fetchseats(){
                $.ajax({
                    url: seat_api_url,
                    type: 'get',
                    success: function(response){
                        let survivals = [];
                        var data = response.results;
                        for(var i = 0; i < data.length; i++) {
                            var row = data[i];
                            var seat = row.seat;
                            $("#player-status-table-name-" + seat).text(row.name);
                            $("#player-status-table-character-" + seat).text(row.character);
                            $("#player-status-table-death-" + seat).text(row.death);
                            if (row.death == "å­˜æ´»") {
                                survivals.push(seat);
                                var action = "<input type='submit' id='player-action-button-" + seat + "'>"
                                $("#player-status-table-action-" + seat).html(action);
                                if (current_stage == "è­¦é•¿ç«é€‰") {
                                    if (row.in_campaign) {
                                        var action_value = "é€€é€‰";
                                        var action_class = "action-quit";
                                        var sheriff_value = "è­¦ä¸Š";
                                    } else {
                                        var action_value = "ç«é€‰";
                                        var action_class = "action-campaign";
                                        var sheriff_value = (row.campaigned) ? "é€€æ°´" : "è­¦ä¸‹" 
                                    }
                                } else {
                                    var action_value = "æ­»äº¡";
                                    var action_class = "action-kill";
                                    var sheriff_value = (row.is_sheriff) ? 'ğŸ‘®' : ''
                                }
                                $("#player-action-button-" + seat).attr('value', action_value).attr('data-seat', seat).attr('class', action_class);
                                $("#player-status-table-sheriff-" + seat).text(sheriff_value);
                                if (sheriff_value == "é€€æ°´") {
                                    $("#player-action-button-" + seat).hide()
                                }
                                bindAction();
                            }
                        }
                        var sheriffOptionsAsString = "<option value='0'>é”€æ¯</option>";
                        for(var i = 0; i < survivals.length; i++) {
                            sheriffOptionsAsString += "<option value='" +  survivals[i] + "'>" +  survivals[i] + "</option>";
                        };
                        $("#sheriff-select").find('option').remove().end().append($(sheriffOptionsAsString));
                    }
                });
            }
            $(document).ready(function(){
                setInterval(fetchseats, 3000);
            });

            var kill_api_url = "/room/" + {{ room.name }} + "/kill";
            var campaign_api_url = "/room/" + {{ room.name }} + "/campaign";
            function bindAction() {
                $(".action-campaign").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                        campaign: true,
                    };
                    $.ajax({
                        type: "POST",
                        url: campaign_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('ä¸Šè­¦æˆåŠŸ')
                            } else {
                                console.log('é€€é€‰æˆåŠŸ')
                            }
                            
                        }
                    })
                })

                $(".action-quit").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                        campaign: false,
                    };
                    $.ajax({
                        type: "POST",
                        url: campaign_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('ä¸Šè­¦æˆåŠŸ')
                            } else {
                                console.log('é€€é€‰æˆåŠŸ')
                            }
                            
                        }
                    })
                })

                $(".action-kill").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                    };
                    $.ajax({
                        type: "POST",
                        url: kill_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('æ­»äº¡')
                            }
                        }
                    })
                })
            }
           

        </script>
    {% else %}
        <label for="vote" id="vote-label"></label><br>
        <select name="vote" id="vote-select"></select>
        <p>
            <input id="vote-button" name="submit" type="submit" value="æŠ•ç¥¨">
        </p>
        <br>
        <p id='vote-stage'></p>
        <div id='vote-results' hidden>
            <p id='vote-results-most-voted'></p>
            <table id='vote-results-table'>
            <thead>
                <tr>
                    <th>è½®æ¬¡</th>
                    <th>ç©å®¶</th>
                    <th>æŠ•ç¥¨ç»™</th>
                <tr>
            </thead>
            <tbody>
            </tbody>
            </table>
        </div>

        <script type="module">
            var status_api_url = "/room/" + {{ room.name }} + "/game_status";
            var candidates_api_url = "/room/" + {{ room.name }} + "/candidates";
            var vote_api_url = "/room/" + {{ room.name }} + "/vote";
            var prev_status = "";
            var prev_stage = "";
            function fetchstatus(){
                $.ajax({
                    url: status_api_url,
                    type: 'get',
                    success: function(response){
                        console.log(response.status);
                        $("#vote-label").text( response.status);
                        if (response.status != prev_status) {
                            prev_status = response.status;
                            if (response.status != "ç­‰å¾…ä¸Šå¸æŒ‡ä»¤") {
                                prev_stage = response.status;
                                console.log(prev_stage);
                                $("#vote-stage").text('æŠ•ç¥¨å·²å¼€å¯');
                                $.getJSON(candidates_api_url, function(data) {
                                    var optionsAsString = "<option value='0'>å¼ƒæƒ</option>";
                                    for(var i = 0; i < data.candidates.length; i++) {
                                        optionsAsString += "<option value='" +  data.candidates[i] + "'>" +  data.candidates[i] + "</option>";
                                    };
                                    $("#vote-select").find('option').remove().end().append($(optionsAsString));
                                });
                            } else {
                                $("#vote-stage").text('æŠ•ç¥¨å·²å…³é—­');
                                $("#vote-select").find('option').remove().end();
                                viewResults();
                            }
                        } 
                    }
                });
            }
            
            {# $(document).ready(function(){
                    setInterval(fetchstatus, 2000);
                });  #} 
                

            $("#vote-button").click(function(){
                var data = {
                    vote_for: $( "#vote-select option:selected" ).val(),
                    player_id: {{ current_user.current_role(room.name).id }},
                    round: $( "#vote-label" ).text()
                };
                $.ajax({
                    type: "POST",
                    url: vote_api_url,
                    data: data,
                    success: function(response) {
                        if (response.vote == 0) {
                            alert("å¼ƒç¥¨");
                        } else if (response.vote == -1) {
                            alert("æœ¬è½®æ— æ³•æŠ•ç¥¨")
                        } else {
                            alert("ä½ æŠ•ç¥¨ç»™" + response.vote + "å·ç©å®¶");
                        }
                        
                    }
                })
            })

            import { playerFetchSeats } from '{{ url_for('static', filename='js/user.js') }}';
            var api_base = "/room/" + {{ room.name }} + "/" + {{ current_user.id }};

            $(document).ready(function() {
                setInterval(function() {
                        playerFetchSeats(api_base,
                            {{ current_user.id}}
                        )
                    }, 1000
                );
            });
        </script>
        
    {% endif %}
    
    
    
{% endblock %}

