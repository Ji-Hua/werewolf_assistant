{% extends "base.html" %}

{% block content %}
    <h1>游戏 {{ room.name }}</h1>
    <h4>当前游戏设置为 {{ room.game.template }}</h4>
    {% if current_user.is_host(room.name) %}
        <h3>你为本游戏的上帝</h3>

        <input id="assign-characters-button" name="submit" type="submit" value="分发身份"><br>
        <input id="lock-characters-button" name="submit" type="submit" value="确认身份"><br>
        <script>
            var assign_character_api_url = "/room/" + {{ room.name }} + "/" + {{ current_user.id }} + "/character";
            console.log({{ current_user.id }})
            console.log(assign_character_api_url)
            $("#assign-characters-button").click(function(){
                var data = {
                    assign_characters: true,
                };
                $.ajax({
                    type: "POST",
                    url: assign_character_api_url,
                    data: data,
                    success: function(response) {
                        if (response.data) {
                            console.log(response.locked)
                        }
                    }
                })
            })
            $("#lock-characters-button").click(function(){
                var data = {
                    assign_characters: false,
                };
                $.ajax({
                    type: "POST",
                    url: assign_character_api_url,
                    data: data,
                    success: function(response) {
                        if (response.data) {
                            console.log(response.locked)
                        }
                    }
                })
            })
        </script>
        <div id='player-status'>
            <table id='player-status-table'>
            <thead>
                <tr>
                    <th>座位号</th>
                    <th>玩家名</th>
                    <th>角色名</th>
                    <th>存活状态</th>
                    <th>警徽状态</th>
                    <th>动作</th>
                <tr>
            </thead>
            <tbody>
            {% for i in range(1, 13) %}
                <tr class='player-status-table-row' id='player-status-table-row-{{i}}'>
                    <td id='player-status-table-seat-{{i}}'>{{i}}</td>
                    <td id='player-status-table-name-{{i}}'></td>
                    <td id='player-status-table-character-{{i}}'></td>
                    <td id='player-status-table-death-{{i}}'></td>
                    <td id='player-status-table-sheriff-{{i}}'></td>
                    <td id='player-status-table-action-{{i}}'></td>
                </tr>
            {% endfor %}
            </tbody>
            </table>
        </div>
        <br>
         <select id='sheriff-select'></select>
         <input id="sheriff-button" name="submit" type="submit" value="授予警徽">
        <br>
        {{ form.round.label }}<br>
        {{ form.round(id='round-select') }}
        <input id="round-button" name="submit" type="submit" value="确认阶段"><br>
        <input id="start-vote-button" name="submit" type="submit" value="开始投票">
        <input id="end-vote-button" name="submit" type="submit" value="结束投票">
        <input id="view-vote-button" name="submit" type="submit" value="查看投票"><br>


        <p id='vote-stage'></p>
        <div id='vote-results' hidden>
            <p id='vote-results-most-voted'></p>
            <table id='vote-results-table'>
            <thead>
                <tr>
                    <th>轮次</th>
                    <th>玩家</th>
                    <th>投票给</th>
                <tr>
            </thead>
            <tbody>
            </tbody>
            </table>
        </div>


        <script>
            var sheriff_api_url = "/room/" + {{ room.name }} + "/sheriff";
            $("#sheriff-button").click(function(){
                var data = {
                    seat: $( "#sheriff-select option:selected" ).val(),
                };
                console.log(data)
                $.ajax({
                    type: "POST",
                    url: sheriff_api_url,
                    data: data,
                    success: function(response) {
                        if (response.sheriff) {
                            console.log(response.sheriff)
                        }
                    }
                })
            })

            $("#round-button").click(function(){
                current_stage = $( "#round-select option:selected" ).val();
            })




            var current_stage = "警长竞选";
            var round_api_url = "/room/" + {{ room.name }} + "/round";
            $("#start-vote-button").click(function(){
                current_stage = $( "#round-select option:selected" ).val()
                var data = {
                    round_name: current_stage,
                    allow_vote: true,
                };
                $.ajax({
                    type: "POST",
                    url: round_api_url,
                    data: data,
                    success: function(response) {
                        if (response.vote == 1) {
                            $("#vote-stage").text('投票已开启')
                        } else {
                            $("#vote-stage").text('投票已结束')
                        }
                    }
                })
            })

            $("#end-vote-button").click(function(){
                var data = {
                    round_name: $( "#round-select option:selected" ).val(),
                    allow_vote: false,
                };
                $.ajax({
                    type: "POST",
                    url: round_api_url,
                    data: data,
                    success: function(response) {
                        if (response.vote == 1) {
                            $("#vote-stage").text('投票已开启')
                        } else {
                            $("#vote-stage").text('投票已结束')
                        }
                    }
                });
                viewResults();
            })

            $("#view-vote-button").click(viewResults)

            function viewResults() {
                $("#vote-results-table tbody").html('');
                var round_name = $( "#round-select option:selected" ).val();
                var result_api_url = "/room/" + {{ room.name }} + "/results/" + round_name;
                $.ajax({
                    type: "GET",
                    url: result_api_url,
                    success: function(response) {
                        var data = response.results;
                        for(var i = 0; i < data.length; i++) {
                            var vote_for = data[i].vote_for;
                            if (vote_for == 0) {
                                vote_for = "弃票"
                            };
                            var row = "<tr><td>" + round_name + "</td><td>" + data[i].vote_from + "</td><td>" + vote_for + "</td></tr>";
                            $('#vote-results-table tbody').append(row);
                        };
                        var most_voted = response.most_voted;
                        console.log(most_voted)
                        if (most_voted.length == 0) {
                            var text_most_voted = "无人得票"
                        } else {
                            var text_most_voted = "得票最多的玩家为";
                            for(var i = 0; i < most_voted.length; i++) {
                                text_most_voted = text_most_voted + " " + most_voted[i];
                            }
                            text_most_voted += " 号玩家"
                        }

                        $("#vote-results-most-voted").text(text_most_voted);
                        $("#vote-results").show();
                    }
                })
            }

            var seat_api_url = "/room/" + {{ room.name }} + "/seats";
            function fetchseats(){
                $.ajax({
                    url: seat_api_url,
                    type: 'get',
                    success: function(response){
                        let survivals = [];
                        var data = response.results;
                        for(var i = 0; i < data.length; i++) {
                            var row = data[i];
                            var seat = row.seat;
                            $("#player-status-table-name-" + seat).text(row.name);
                            $("#player-status-table-character-" + seat).text(row.character);
                            $("#player-status-table-death-" + seat).text(row.death);
                            if (row.death == "存活") {
                                survivals.push(seat);
                                var action = "<input type='submit' id='player-action-button-" + seat + "'>"
                                $("#player-status-table-action-" + seat).html(action);
                                if (current_stage == "警长竞选") {
                                    if (row.in_campaign) {
                                        var action_value = "退选";
                                        var action_class = "action-quit";
                                        var sheriff_value = "警上";
                                    } else {
                                        var action_value = "竞选";
                                        var action_class = "action-campaign";
                                        var sheriff_value = (row.campaigned) ? "退水" : "警下" 
                                    }
                                } else {
                                    var action_value = "死亡";
                                    var action_class = "action-kill";
                                    var sheriff_value = (row.is_sheriff) ? '👮' : ''
                                }
                                $("#player-action-button-" + seat).attr('value', action_value).attr('data-seat', seat).attr('class', action_class);
                                $("#player-status-table-sheriff-" + seat).text(sheriff_value);
                                if (sheriff_value == "退水") {
                                    $("#player-action-button-" + seat).hide()
                                }
                                bindAction();
                            }
                        }
                        var sheriffOptionsAsString = "<option value='0'>销毁</option>";
                        for(var i = 0; i < survivals.length; i++) {
                            sheriffOptionsAsString += "<option value='" +  survivals[i] + "'>" +  survivals[i] + "</option>";
                        };
                        $("#sheriff-select").find('option').remove().end().append($(sheriffOptionsAsString));
                    }
                });
            }
            $(document).ready(function(){
                setInterval(fetchseats, 3000);
            });

            var kill_api_url = "/room/" + {{ room.name }} + "/kill";
            var campaign_api_url = "/room/" + {{ room.name }} + "/campaign";
            function bindAction() {
                $(".action-campaign").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                        campaign: true,
                    };
                    $.ajax({
                        type: "POST",
                        url: campaign_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('上警成功')
                            } else {
                                console.log('退选成功')
                            }
                            
                        }
                    })
                })

                $(".action-quit").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                        campaign: false,
                    };
                    $.ajax({
                        type: "POST",
                        url: campaign_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('上警成功')
                            } else {
                                console.log('退选成功')
                            }
                            
                        }
                    })
                })

                $(".action-kill").click(function(){
                    console.log($(this).data('seat'))
                    var data = {
                        seat: $(this).data('seat'),
                    };
                    $.ajax({
                        type: "POST",
                        url: kill_api_url,
                        data: data,
                        success: function(response) {
                            if (response.campaign) {
                                console.log('死亡')
                            }
                        }
                    })
                })
            }
           

        </script>
    {% else %}
        {% if current_user.current_role(room.name).is_seated %}
        <script>
            
        </script>
            <h3> 你的座位为 {{current_user.current_role(room.name).seat}} </h3>
            <div id='player-character-div'>
                <h4>身份</h4>
                <img id="player-character-img" width=128 height=128>
                <p id="player-character-text"></p>
            </div>
            <br>
                <label for="vote" id="vote-label"></label><br>
                <select name="vote" id="vote-select"></select>
                <p>
                    <input id="vote-button" name="submit" type="submit" value="投票">
                </p>
                <br>
                <p id='vote-stage'></p>
                <div id='vote-results' hidden>
                    <p id='vote-results-most-voted'></p>
                    <table id='vote-results-table'>
                    <thead>
                        <tr>
                            <th>轮次</th>
                            <th>玩家</th>
                            <th>投票给</th>
                        <tr>
                    </thead>
                    <tbody>
                    </tbody>
                    </table>
                </div>
            <script>
                var status_api_url = "/room/" + {{ room.name }} + "/game_status";
                var candidates_api_url = "/room/" + {{ room.name }} + "/candidates";
                var vote_api_url = "/room/" + {{ room.name }} + "/vote";
                var prev_status = "";
                var prev_stage = "";
                function fetchstatus(){
                    $.ajax({
                        url: status_api_url,
                        type: 'get',
                        success: function(response){
                            console.log(response.status);
                            $("#vote-label").text( response.status);
                            if (response.status != prev_status) {
                                prev_status = response.status;
                                if (response.status != "等待上帝指令") {
                                    prev_stage = response.status;
                                    console.log(prev_stage);
                                    $("#vote-stage").text('投票已开启');
                                    $.getJSON(candidates_api_url, function(data) {
                                        var optionsAsString = "<option value='0'>弃权</option>";
                                        for(var i = 0; i < data.candidates.length; i++) {
                                            optionsAsString += "<option value='" +  data.candidates[i] + "'>" +  data.candidates[i] + "</option>";
                                        };
                                        $("#vote-select").find('option').remove().end().append($(optionsAsString));
                                    });
                                } else {
                                    $("#vote-stage").text('投票已关闭');
                                    $("#vote-select").find('option').remove().end();
                                    viewResults();
                                }
                            } 
                        }
                    });
                }
                function viewResults() {
                    $("#vote-results-table tbody").html('');
                    var result_api_url = "/room/" + {{ room.name }} + "/results/" + prev_stage;
                    console.log(result_api_url);
                    $.ajax({
                        type: "GET",
                        url: result_api_url,
                        success: function(response) {
                            var data = response.results;
                            for(var i = 0; i < data.length; i++) {
                                var vote_for = data[i].vote_for;
                                if (vote_for == 0) {
                                    vote_for = "弃票"
                                };
                                var row = "<tr><td>" + prev_stage + "</td><td>" + data[i].vote_from + "</td><td>" + vote_for + "</td></tr>";
                                $('#vote-results-table tbody').append(row);
                            };
                            var most_voted = response.most_voted;
                            console.log(most_voted);
                            if (most_voted.length == 0) {
                                var text_most_voted = "无人得票"
                            } else {
                                var text_most_voted = "得票最多的玩家为";
                                for(var i = 0; i < most_voted.length; i++) {
                                    text_most_voted = text_most_voted + " " + most_voted[i];
                                }
                                text_most_voted += " 号玩家"
                            }

                            $("#vote-results-most-voted").text(text_most_voted);
                            $("#vote-results").show();
                        }
                    })
                }
                var api_base =  "/room/" + {{ room.name }} + "/" + {{ current_user.id }}
                var locked = false
                function fetchCharacter(url_base, old_name) {
                    $.ajax({
                        type: "GET",
                        url: url_base + "/character",
                        success: function(response) {
                            if (response) {
                                locked = response.locked
                                if (response.character != old_name) {
                                    $("#player-character-img").attr('src', response.image_url);
                                    $("#player-character-text").text(response.character);
                                }
                            }
                        }
                    })
                }

                $(document).ready(function(){
                    setInterval(function() {
                            fetchstatus();
                            if (!locked) {
                                var old_character = $("#player-character-text").text();
                                fetchCharacter(api_base, old_character);
                            }
                        }, 2000
                    );
                });
                $("#vote-button").click(function(){
                    var data = {
                        vote_for: $( "#vote-select option:selected" ).val(),
                        player_id: {{ current_user.current_role(room.name).id }},
                        round: $( "#vote-label" ).text()
                    };
                    $.ajax({
                        type: "POST",
                        url: vote_api_url,
                        data: data,
                        success: function(response) {
                            if (response.vote == 0) {
                                alert("弃票");
                            } else if (response.vote == -1) {
                                alert("本轮无法投票")
                            } else {
                                alert("你投票给" + response.vote + "号玩家");
                            }
                            
                        }
                    })
                })
            </script>
        {% else %}
            <form action="" method="post">
                {{ seat_form.csrf_token }}
                {{ seat_form.hidden_tag() }}
                <p>
                    {{ seat_form.seat.label }}
                    {{ seat_form.seat(id='seat-select') }}
                    {% for error in seat_form.seat.errors %}
                        <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </p>
                <p>{{ seat_form.submit() }}</p>
            </form>
            <script>
                var api_url = "/room/" + {{ room.name }} + "/available_seats";
                $(document).ready(function() {
                    $.getJSON(api_url, function(data) {
                        var optionsAsString = "";
                        for(var i = 0; i < data.seats.length; i++) {
                            optionsAsString += "<option value='" +  data.seats[i] + "'>" +  data.seats[i] + "</option>";
                        };
                        $("#seat-select").find('option').remove().end().append($(optionsAsString));
                    });
                });
        
            </script>
        {% endif %}
    {% endif %}
    
{% endblock %}

