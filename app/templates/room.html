{% extends "base.html" %}

{% block content %}
    <h1>游戏 {{ room.name }}</h1>
    <h4>当前游戏设置为 <span>{{ room.game.template }}</span></h4>
    <h4>当前游戏阶段为 <span id='round-info-head'></span></h4>
    <h4>当前投票阶段为 <span id='vote-info-head'></span></h4>
    {% if current_user.is_host(room.name) %}
        <h3>你为本游戏的上帝</h3>
        <div id='ingame-action-div'>
            <div id='round-info-div'>
                <label for="round">选择当前轮次</label><br>
                <select id="round-select" name="round">
                    <option value="准备阶段">准备阶段</option>
                    <option value="分发身份">分发身份</option>
                    <option value="警长竞选">警长竞选</option>
                    <option value="第1天">第1天</option>
                    <option value="第2天">第2天</option>
                    <option value="第3天">第3天</option>
                    <option value="第4天">第4天</option>
                    <option value="第5天">第5天</option>
                </select>
                <input id="round-button" name="submit" type="submit" value="确认阶段"><br>
            </div>
            <br>
            <div id='vote-buttons-div'>
                <input id="start-vote-button" name="submit" type="submit" value="开始投票">
                <input id="end-vote-button" name="submit" type="submit" value="结束投票">
            </div>
            <br>
        </div>
        <script type="module">
            import { updateRound, assignCharacters } from '{{ url_for('static', filename='js/host.js') }}';
            var api_base = "/room/" + {{ room.name }} + "/" + {{ current_user.id }};

            $("#round-button").click(function(){
                var current_stage = $( "#round-select option:selected" ).val();
                updateRound(api_base, current_stage, 0);
                if (current_stage == "分发身份") {
                    assignCharacters(api_base);
                }
                fetchRound(api_base);
            })

            $("#start-vote-button").click(function(){
                var current_stage = $( "#round-select option:selected" ).val();
                var invalid_round = ["准备阶段", "分发身份", "等待上帝指令"];
                 if (!(invalid_round.includes(current_stage))) {
                    updateRound(api_base, current_stage, 1);
                    $("#vote-info-head").text("开启");
                }
            })

            $("#end-vote-button").click(function(){
                var current_stage = $( "#round-select option:selected" ).val();
                var invalid_round = ["准备阶段", "分发身份", "等待上帝指令"];
                if (!(invalid_round.includes(current_stage))) {
                    updateRound(api_base, current_stage, 0);
                    $("#vote-info-head").text("关闭");
                }
            })

        </script>
    {% else %}
        <div id='player-character-div'>
            <h4>身份</h4>
            <img id="player-character-img" width=128 height=128>
            <p id="player-character-text"></p>
        </div>
        <br>
    {% endif %}
    <p>投票轮次: <span id='vote-stage-span'></span></p>
    <p>得票最多: <span id='vote-max-span'></span></p>
    <div id='player-status'>
        <table id='player-status-table'>
            <thead>
                <tr>
                    <th>座位号</th>
                    <th>玩家名</th>
                    <th>角色名</th>
                    <th>存活状态</th>
                    <th>警徽状态</th>
                    <th>投票给</th>
                    <th>行动</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(1, 13) %}
                <tr class='player-status-table-row' id='player-status-table-row-{{i}}'>
                    <td id='player-status-table-seat-{{i}}'>{{i}}</td>
                    <td id='player-status-table-name-{{i}}'></td>
                    <td id='player-status-table-character-{{i}}'></td>
                    <td id='player-status-table-death-{{i}}'></td>
                    <td id='player-status-table-sheriff-{{i}}'></td>
                    <td id='player-status-table-votefor-{{i}}'></td>
                    <td id='player-status-table-action-{{i}}'></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if current_user.is_host(room.name) %}
        <script type="module">
            import { hostFetchSeats } from '{{ url_for('static', filename='js/host.js') }}';
            var api_base = "/room/" + {{ room.name }} + "/" + {{ current_user.id }};
             $(document).ready(function() {
                setInterval(function() {
                        hostFetchSeats(api_base,
                            {{ current_user.id }}
                        );
                        fetchRound(api_base, {{ current_user.id }});
                    }, 1000
                );
            });
        </script>
    {% else %}
        <script type="module">
            import { playerFetchSeats, fetchCharacter } from '{{ url_for('static', filename='js/player.js') }}';
            var api_base = "/room/" + {{ room.name }} + "/" + {{ current_user.id }};

            $(document).ready(function() {
                setInterval(function() {
                        playerFetchSeats(api_base,
                            {{ current_user.id }}
                        );
                        var old_character = $("#player-character-text").text();
                        fetchCharacter(api_base, old_character);
                        fetchRound(api_base, {{ current_user.id }});
                    }, 1000
                );
            });
        </script>
        
    {% endif %}
    <script>
        function fetchRound(url_base) {
            $.ajax({
                type: "GET",
                url: url_base + "/round",
                success: function(response) {
                    if (response.round_name) {
                        $("#round-info-head").text(response.round_name);
                        {% if not current_user.is_host(room.name) %}
                        if (response.in_vote) {
                            $("#vote-info-head").text("投票进行中");
                        } else {
                            $("#vote-info-head").text("投票未开启");
                        }
                        {% endif %}
                    } else {
                        console.log('获取回合失败')
                    }
                }
            })
        }
    </script>


{% endblock %}

